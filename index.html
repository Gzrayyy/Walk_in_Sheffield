<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Walkability Survey - Sheffield Research</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="sample_data.js"></script>
    <script src="gen.js"></script>
    
    <style>
        body { font-size: 32px; background-color: #f8fafc; line-height: 1.6; scroll-behavior: smooth; font-family: system-ui, -apple-system, sans-serif; }
        
        /* ÊåâÈíÆ‰∏éÂç°Áâá‰∫§‰∫í / Interaction Styles */
        .info-btn { transition: all 0.2s ease; border-radius: 24px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .info-btn:active { transform: scale(0.96); }
        
        .location-card { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); border-width: 10px; }
        
        /* ÈÄâ‰∏≠Áä∂ÊÄÅÂä®Áîª / Selection Animations */
        .border-green-500 { animation: pulse-green 2s infinite; z-index: 10; }
        .border-red-500 { animation: pulse-red 2s infinite; z-index: 10; }

        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.5); }
            70% { box-shadow: 0 0 0 25px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.5); }
            70% { box-shadow: 0 0 0 25px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* ÂìçÂ∫îÂºèË∞ÉÊï¥ / Layout Tweaks */
        #app { min-height: auto !important; }
        .progress-text { font-size: 24px; color: #475569; font-weight: 800; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-6">

    <div id="status-bar" class="w-full max-w-6xl flex justify-between items-center mb-8 bg-white/90 backdrop-blur sticky top-0 z-50 p-6 rounded-[32px] shadow-lg border border-gray-100">
        <span class="progress-text" id="progress-step">Preparing...</span>
        <div class="w-2/3 bg-gray-200 h-8 rounded-full overflow-hidden border-4 border-white shadow-inner">
            <div id="progress-bar" class="bg-blue-600 h-full w-0 transition-all duration-700 ease-out"></div>
        </div>
    </div>

    <div id="app" class="w-full max-w-6xl bg-white rounded-[60px] p-12 shadow-2xl border border-gray-50">
        </div>

    <script>

        window.onbeforeunload = function() {
        return "Your progress will be lost if you leave this page.";};

        const SUPABASE_URL = 'https://zuvbanupgxjoftrrvoqt.supabase.co'; // Â°´ÂÖ• image_5c4aab.png ÈáåÁöÑÂú∞ÂùÄ
        const SUPABASE_KEY = 'sb_publishable_Wh4FHWihk-fOTYBrhhIHew_9cOIYESN'; // Â°´ÂÖ• image_5c4acc.png ÈáåÁöÑ Key
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- 1. ÂÖ®Â±ÄÁä∂ÊÄÅ / Global State ---
        let currentIdx = -1; 
        let currentRoundSelection = { best: null, worst: null };
        let results = { 
            user: { gender: '', age: '', mobility: '', duration: '', purpose: '', values: [], otherValue: '' }, 
            votes: [],   
            votes_p3: [] 
        };

        let surveyPool = [];   
        let surveyPoolP3 = []; 
        const MAX_P2_ROUNDS = 13; 
        const MAX_P3_ROUNDS = 12; 
        const LOCS_PER_ROUND = 4; 
        const CONTEXTS = ['cloudy', 'night', 'rainy', 'snowy', 'sunny'];

        const app = document.getElementById('app');

        // --- 2. ÂàùÂßãÂåñ‰∏éÈöèÊú∫ÁÆóÊ≥ï ---
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function initSurvey() {
            // --- Part 2 ÂàùÂßãÂåñ (‰ΩøÁî® sample_data.js ÈáåÁöÑ streetViews) ---
            if (typeof streetViews === 'undefined') return;
            let allLocsP2 = [...streetViews];
            shuffle(allLocsP2);
            surveyPool = allLocsP2.slice(0, MAX_P2_ROUNDS * LOCS_PER_ROUND);
            
            // --- Part 3 ÂàùÂßãÂåñ (Ê†∏ÂøÉÈÄªËæëÊîπËøõ) ---
            if (typeof streetViewsP3 === 'undefined') return;
            let p3Locs = [...streetViewsP3]; // 32‰∏™ÂéüÂßãÂú∞ÁÇπ
            shuffle(p3Locs); // ÂÖàÊâì‰π±È°∫Â∫è

            // 1. Stage 1: Ââç 6 ËΩÆ (Âêå‰∏ÄÂú∞ÁÇπÂØπÊØî 5 ÁßçÂ§©Ê∞î)
            // Ê∂àËÄó 6 ‰∏™Áâ©ÁêÜ ID
            let stage1Locs = p3Locs.slice(0, 6);
            stage1Locs.forEach(loc => {
                let round = CONTEXTS.map(ctx => ({
                    id: loc.id,
                    context: ctx,
                    images: loc.images.filter(img => img.toLowerCase().includes(ctx)).slice(0, 4)
                }));
                surveyPoolP3.push(round);
            });

            // 2. Stage 2: Âêé 6 ËΩÆ (‰ªé 160 ‰∏™ÁªÑÂêàÊ±†‰∏≠ÈöèÊú∫ÊçûÂèñ)
            // È¶ñÂÖàÔºåÊääÂâ©‰∏ãÁöÑ 26 ‰∏™Áâ©ÁêÜÂú∞ÁÇπÊãÜËß£Êàê 26 * 5 = 130 ‰∏™ÁªÑÂêà
            let comboPool = [];
            let remainingLocs = p3Locs.slice(6); // ÊéíÈô§Êéâ Stage 1 Áî®ËøáÁöÑ ID ‰ª•Â¢ûÂä†Â§öÊ†∑ÊÄß
            
            remainingLocs.forEach(loc => {
                CONTEXTS.forEach(ctx => {
                    comboPool.push({
                        id: loc.id,
                        context: ctx,
                        images: loc.images.filter(img => img.toLowerCase().includes(ctx)).slice(0, 4)
                    });
                });
            });

            // Áé∞Âú® comboPool ÈáåÊúâ 130 ‰∏™ÁªÑÂêàÔºåÊàë‰ª¨Âè™ÈúÄË¶Å 30 ‰∏™ (6ËΩÆ * 5ÈÄâÈ°π)
            shuffle(comboPool); 
            let stage2Combos = comboPool.slice(0, 30);

            // Â∞ÜËøô 30 ‰∏™ÁªÑÂêàÂàÜÈÖçÂà∞ 6 ‰∏™ËΩÆÊ¨°‰∏≠
            for(let i = 0; i < 6; i++) {
                let round = stage2Combos.slice(i * 5, (i + 1) * 5);
                surveyPoolP3.push(round);
            }
            
            console.log("Part 3 Pool Generated:", surveyPoolP3); // Ë∞ÉËØïÁî®
        }

        // --- 3. Ê∏≤ÊüìÊéßÂà∂Âô® ---
        function updateUI() {
            if (currentIdx === -1) {
                renderCombinedInfo(); 
            } else if (currentIdx < surveyPool.length) {
                renderVote(); 
            } else if (currentIdx === 999) {
                renderPart3Bridge(); 
            } else if (currentIdx >= 1000 && (currentIdx - 1000) < MAX_P3_ROUNDS) {
                renderVoteP3(); 
            } else {
                renderEnd();
            }
            updateProgress();
        }

        // --- 4. È°µÈù¢Ê∏≤Êüì ---
        function renderCombinedInfo() {
            app.innerHTML = `
                <div class="space-y-16 pb-10">
                    <h1 class="text-6xl font-black text-center text-slate-900 mb-4">Part 1: Basic information </h1>
                    <p class="text-3xl text-center text-slate-500 mb-12 italic">This helps us understand your walking needs.</p>
                    <section class="bg-slate-50 p-8 rounded-[40px]">
                        <h2 class="text-4xl font-extrabold mb-8 text-slate-800">1. What is your gender?</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            ${['Male', 'Female', 'Prefer not to say'].map(v => `<button onclick="selectInfo('gender', '${v}', this)" class="info-btn bg-white border-4 border-gray-200 py-10 text-3xl font-bold hover:border-blue-400">${v}</button>`).join('')}
                        </div>
                    </section>
                    <section class="bg-slate-50 p-8 rounded-[40px]">
                        <h2 class="text-4xl font-extrabold mb-8 text-slate-800">2. What is your age?</h2>
                        <div class="grid grid-cols-3 gap-6">${['55-64', '65-74', '75+'].map(v => `<button onclick="selectInfo('age', '${v}', this)" class="info-btn bg-white border-4 border-gray-200 py-10 text-3xl font-bold hover:border-emerald-400">${v}</button>`).join('')}</div>
                    </section>
                    <section class="bg-slate-50 p-8 rounded-[40px]">
                        <h2 class="text-4xl font-extrabold mb-8 text-slate-800">3. Mobility Status?</h2>
                        <div class="space-y-6">
                            <button onclick="selectInfo('mobility', 'Independent', this)" class="info-btn w-full bg-white border-4 border-gray-200 py-8 text-3xl font-bold px-12 text-left">Independent (Can walk alone)</button>
                            <button onclick="selectInfo('mobility', 'Assisted', this)" class="info-btn w-full bg-white border-4 border-gray-200 py-8 text-3xl font-bold px-12 text-left">Assisted (Use cane/walker)</button>
                            <button onclick="selectInfo('mobility', 'Dependent', this)" class="info-btn w-full bg-white border-4 border-gray-200 py-8 text-3xl font-bold px-12 text-left">Dependent (Need help)</button>
                        </div>
                    </section>
                    <section class="bg-slate-50 p-8 rounded-[40px]">
                        <h2 class="text-4xl font-extrabold mb-8 text-slate-800">4. Daily walk duration?</h2>
                        <div class="grid grid-cols-3 gap-6">${['<10min', '10-20min', '20min+'].map(v => `<button onclick="selectInfo('duration', '${v}', this)" class="info-btn bg-white border-4 border-gray-200 py-10 text-3xl font-bold hover:border-orange-400">${v}</button>`).join('')}</div>
                    </section>
                    <section class="bg-slate-50 p-8 rounded-[40px]">
                        <h2 class="text-4xl font-extrabold mb-8 text-slate-800">5. Main purpose?</h2>
                        <div class="grid grid-cols-2 gap-6">${['Recreational', 'Utilitarian'].map(v => `<button onclick="selectInfo('purpose', '${v}', this)" class="info-btn bg-white border-4 border-gray-200 py-10 text-3xl font-bold hover:border-red-400">${v}</button>`).join('')}</div>
                    </section>
                    <section id="q6-section" class="bg-indigo-50 p-8 rounded-[40px] border-4 border-indigo-100">
                        <h2 class="text-4xl font-extrabold mb-2 text-indigo-900">6. What do you value most? (Rank)</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
                            ${[{id:'Greenery',l:'Greenery'},{id:'POI',l:'POI'},{id:'Infrastructure',l:'Infrastructure'},{id:'Slopes',l:'Slopes'}].map(item => `
                                <button onclick="toggleRank('${item.id}', this)" class="info-btn rank-btn bg-white border-4 border-gray-200 py-12 text-3xl font-extrabold flex justify-between px-10 items-center">
                                    <span>${item.l}</span><span class="rank-badge hidden bg-indigo-600 text-white w-14 h-14 rounded-full flex items-center justify-center text-4xl shadow-lg"></span>
                                </button>
                            `).join('')}
                        </div>
                    </section>
                    <button id="start-btn" onclick="startVoting()" class="w-full py-16 bg-slate-300 text-white rounded-[40px] text-6xl font-black shadow-2xl cursor-not-allowed" disabled>START RESEARCH</button>
                </div>
            `;
        }

        function renderVote() {
            const locationsToShow = surveyPool.slice(currentIdx, currentIdx + 4);
            app.innerHTML = `
                <div class="space-y-8">
                    <div class="text-center bg-slate-50 py-8 rounded-[40px] border-4 border-slate-100">
                        <h2 class="text-5xl font-black text-slate-900 mb-4 uppercase">Part 2: Location Comparison</h2>
                        <p id="vote-instruction" class="text-3xl text-slate-700 font-bold">Select the one you <span class="text-green-600 underline text-4xl">MOST</span> and <span class="text-red-600 underline text-4xl">LEAST</span> PREFER</p>
                    </div>
                    <div class="flex flex-col gap-6">
                        ${locationsToShow.map((loc, index) => `
                            <div onclick="handleLocationClick('${loc.id}', this)" class="location-card bg-white border-gray-200 rounded-[40px] p-6 shadow-xl cursor-pointer relative group border-[8px]">
                                <div class="flex justify-between items-center mb-4 px-4">
                                    <span class="text-4xl font-black text-slate-300">OPTION ${String.fromCharCode(65 + index)}</span>
                                    <span class="status-label hidden text-3xl font-black italic px-8 py-2 rounded-full shadow-md"></span>
                                </div>
                                <div class="grid grid-cols-4 gap-3 rounded-[30px] overflow-hidden pointer-events-none">
                                    ${loc.images.slice(0,4).map(img => `<img src="filtered_sample_images/${img}" class="w-full h-[240px] object-cover">`).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="flex justify-center items-center gap-12 pt-10">
                        <button onclick="goBack()" class="flex items-center text-3xl text-slate-400 font-bold hover:text-blue-600"><span class="mr-3 text-4xl">‚¨ÖÔ∏è</span> Go Back</button>
                        <div class="w-[2px] h-12 bg-slate-200"></div>
                        <button onclick="resetRound()" class="flex items-center text-3xl text-slate-400 font-bold hover:text-orange-500"><span class="mr-3 text-4xl">üîÑ</span> Reset Current</button>
                    </div>
                </div>
            `;
            window.scrollTo(0, 0);
        }

        function renderPart3Bridge() {
            app.innerHTML = `
                <div class="text-center py-24 space-y-16">
                    <div class="text-[180px]">üåÜ</div>
                    <h2 class="text-8xl font-black text-indigo-600 uppercase">Part 2 Complete!</h2>
                    <p class="text-4xl text-slate-500 font-medium px-12">Next, we will look at how weather and time affect your walking preference.</p>
                    <div class="bg-indigo-50 p-12 rounded-[60px] border-4 border-indigo-100 inline-block shadow-2xl">
                        <p class="text-5xl font-bold text-indigo-800 mb-8">Ready for Part 3? (12 Rounds)</p>
                        <button onclick="currentIdx = 1000; updateUI();" class="px-24 py-12 bg-indigo-600 text-white rounded-full text-5xl font-black shadow-2xl hover:bg-indigo-700 transition-all active:scale-95">START PART 3</button>
                    </div>
                </div>
            `;
        }

        function renderVoteP3() {
            const roundIdx = currentIdx - 1000;
            const options = surveyPoolP3[roundIdx];
            const isStage1 = roundIdx < 6;
            app.innerHTML = `
                <div class="space-y-8">
                    <div class="text-center bg-indigo-50 py-8 rounded-[40px] border-4 border-indigo-100 mb-6">
                        <h2 class="text-5xl font-black text-indigo-900 mb-4 uppercase">Part 3: Environmental Context</h2>
                        <p id="vote-instruction" class="text-3xl text-slate-700 font-bold px-10">
                            ${isStage1 ? 'Compare the <span class="text-indigo-600">SAME PLACE</span> in 5 different weathers.' : 'Compare <span class="text-indigo-600">DIFFERENT PLACES</span> in different weathers.'}<br>
                            Select the one you <span class="text-green-600 underline text-4xl">MOST</span> and <span class="text-red-600 underline text-4xl">LEAST</span> PREFER
                        </p>
                    </div>
                    <div class="flex flex-col gap-6">
                        ${options.map((opt, index) => `
                            <div onclick="handleLocationClickP3('${opt.id}', '${opt.context}', this)" class="location-card bg-white border-gray-200 rounded-[40px] p-6 shadow-xl cursor-pointer relative group border-[8px]">
                                <div class="flex justify-between items-center mb-4 px-4">
                                    <span class="text-3xl font-black text-slate-300 uppercase">OPTION ${String.fromCharCode(65 + index)}: ${opt.context}</span>
                                    <span class="status-label hidden text-2xl font-black italic px-8 py-2 rounded-full shadow-md"></span>
                                </div>
                                <div class="grid grid-cols-4 gap-3 rounded-[30px] overflow-hidden pointer-events-none">
                                    ${opt.images.map(img => `<img src="generated_weather_images/${img}" class="w-full h-[240px] object-cover">`).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="flex justify-center items-center gap-12 pt-10">
                        <button onclick="goBackP3()" class="flex items-center text-3xl text-slate-400 font-bold hover:text-blue-600"><span class="mr-3 text-4xl">‚¨ÖÔ∏è</span> Go Back</button>
                        <div class="w-[2px] h-12 bg-slate-200"></div>
                        <button onclick="currentRoundSelection={best:null,worst:null};renderVoteP3();" class="flex items-center text-3xl text-slate-400 font-bold hover:text-orange-500"><span class="mr-3 text-4xl">üîÑ</span> Reset Current</button>
                    </div>
                </div>
            `;
            window.scrollTo(0, 0);
        }

        // --- 5. ‰∫§‰∫íÊ†∏ÂøÉÈÄªËæë ---
        function selectInfo(k, v, el) {
            results.user[k] = v;
            el.parentElement.querySelectorAll('.info-btn').forEach(btn => {
                btn.classList.remove('border-blue-600', 'ring-8'); btn.classList.add('border-gray-200');
            });
            el.classList.add('border-blue-600', 'ring-8');
            const u = results.user;
            if (u.gender && u.age && u.mobility && u.duration && u.purpose) {
                const b = document.getElementById('start-btn');
                b.classList.remove('bg-slate-300', 'cursor-not-allowed'); b.classList.add('bg-blue-600'); b.disabled = false;
            }
        }

        function toggleRank(id, el) {
            const arr = results.user.values; const idx = arr.indexOf(id);
            if (idx > -1) arr.splice(idx, 1); else arr.push(id);
            document.querySelectorAll('.rank-btn').forEach(btn => {
                const bid = btn.getAttribute('onclick').match(/'([^']+)'/)[1];
                const bdg = btn.querySelector('.rank-badge'); const ord = arr.indexOf(bid);
                if (ord > -1) { bdg.innerText = ord + 1; bdg.classList.remove('hidden'); btn.classList.add('border-indigo-600', 'bg-indigo-50'); }
                else { bdg.classList.add('hidden'); btn.classList.remove('border-indigo-600'); }
            });
        }

        function handleLocationClick(id, el) {
            if (!currentRoundSelection.best) {
                currentRoundSelection.best = id; el.classList.add('border-green-500', 'bg-green-50');
                const lbl = el.querySelector('.status-label'); lbl.innerText = "‚ù§Ô∏è BEST"; lbl.classList.remove('hidden'); lbl.classList.add('bg-green-600', 'text-white');
                document.getElementById('vote-instruction').innerHTML = `Select the one you <span class="text-red-600 underline text-4xl">LEAST</span> PREFER`;
            } else if (!currentRoundSelection.worst && id !== currentRoundSelection.best) {
                currentRoundSelection.worst = id; el.classList.add('border-red-500', 'bg-red-50');
                const lbl = el.querySelector('.status-label'); lbl.innerText = "‚ùå WORST"; lbl.classList.remove('hidden'); lbl.classList.add('bg-red-600', 'text-white');
                setTimeout(saveRound, 1200);
            }
        }

        function handleLocationClickP3(id, ctx, el) {
            if (!currentRoundSelection.best) {
                currentRoundSelection.best = { id, ctx }; el.classList.add('border-green-500', 'bg-green-50');
                const lbl = el.querySelector('.status-label'); lbl.innerText = "‚ù§Ô∏è BEST"; lbl.classList.remove('hidden'); lbl.classList.add('bg-green-600', 'text-white');
                document.getElementById('vote-instruction').innerHTML = `Select the one you <span class="text-red-600 underline text-4xl">LEAST</span> PREFER`;
            } else if (!currentRoundSelection.worst && (id !== currentRoundSelection.best.id || ctx !== currentRoundSelection.best.ctx)) {
                currentRoundSelection.worst = { id, ctx }; el.classList.add('border-red-500', 'bg-red-50');
                const lbl = el.querySelector('.status-label'); lbl.innerText = "‚ùå WORST"; lbl.classList.remove('hidden'); lbl.classList.add('bg-red-600', 'text-white');
                setTimeout(saveRoundP3, 1200);
            }
        }

        function saveRound() {
            results.votes.push({ round: Math.floor(currentIdx/4)+1, best: currentRoundSelection.best, worst: currentRoundSelection.worst });
            currentRoundSelection = { best: null, worst: null }; currentIdx += 4;
            if(currentIdx >= 52) currentIdx = 999;
            updateUI();
        }

        function saveRoundP3() {
            results.votes_p3.push({ round: (currentIdx-1000)+1, best: currentRoundSelection.best, worst: currentRoundSelection.worst });
            currentRoundSelection = { best: null, worst: null }; currentIdx++;
            updateUI();
        }

        function goBack() { 
            if (currentIdx === 0) currentIdx = -1; else if (currentIdx === 999) currentIdx = 48; else currentIdx -= 4;
            results.votes.pop(); currentRoundSelection = { best: null, worst: null }; updateUI(); 
        }

        function goBackP3() {
            if (currentIdx === 1000) currentIdx = 999; else { currentIdx--; results.votes_p3.pop(); }
            currentRoundSelection = { best: null, worst: null }; updateUI();
        }

        function resetRound() { currentRoundSelection = { best: null, worst: null }; renderVote(); }
        function startVoting() { initSurvey(); currentIdx = 0; updateUI(); window.scrollTo(0,0); }

        async function renderEnd() {
            // 1. Á´ãÂç≥Ê∏≤ÊüìÈ°µÈù¢ÔºåÁßªÈô§‚Äú‰∏ãËΩΩÊñá‰ª∂‚ÄùÁöÑÊèêÁ§∫ÊñáÂ≠ó
            app.innerHTML = `
                <div class="text-center py-24 space-y-16">
                    <div id="upload-status" class="text-4xl font-bold text-blue-600 animate-pulse">
                        üì§ Sending your results to the cloud...
                    </div>
                    <div class="text-[200px] animate-bounce">üèôÔ∏è</div>
                    <h2 class="text-9xl font-black text-green-600 uppercase tracking-tighter">Finished!</h2>
                    <p class="text-5xl text-slate-500 px-12 leading-tight font-medium">
                        Thank you! Your choices help improve walkability in Sheffield.
                    </p>
                    <button onclick="location.reload()" class="text-3xl text-slate-400 underline pt-10 block mx-auto">
                        Restart Survey
                    </button>
                </div>
            `;

            // 2. ÂáÜÂ§áÂπ∂‰∏ä‰º†Âà∞ Supabase
            try {
                const { error } = await _supabase
                    .from('survey_responses') // ÂØπÂ∫î‰Ω†ÁöÑË°®Âêç
                    .insert([{ payload: results }]); // Â∞ÜÊï¥‰∏™ results Â≠òÂÖ• payload

                const statusEl = document.getElementById('upload-status');
                if (error) throw error;

                // 3. ‰∏ä‰º†ÊàêÂäüÂêéÔºåÊõ¥Êñ∞Áä∂ÊÄÅÊñáÂ≠óÔºå‰∏çÂÜçÂºπÂá∫‰∏ãËΩΩÊ°Ü
                statusEl.innerHTML = "‚úÖ Results saved successfully!";
                statusEl.classList.remove('animate-pulse', 'text-blue-600');
                statusEl.classList.add('text-green-600');
                
            } catch (err) {
                console.error('Upload Error:', err);
                const statusEl = document.getElementById('upload-status');
                statusEl.innerHTML = "‚ùå Upload failed. Please contact the researcher.";
                statusEl.classList.remove('animate-pulse', 'text-blue-600');
                statusEl.classList.add('text-red-600');
            }
        }

        function updateProgress() {
            const totalSteps = 1 + MAX_P2_ROUNDS + 1 + MAX_P3_ROUNDS;
            let currentStep;
            if (currentIdx === -1) currentStep = 1;
            else if (currentIdx < 999) currentStep = Math.floor(currentIdx / 4) + 2;
            else if (currentIdx === 999) currentStep = 1 + MAX_P2_ROUNDS + 1;
            else currentStep = (currentIdx - 1000) + 1 + MAX_P2_ROUNDS + 1 + 1;
            const display = currentStep > totalSteps ? totalSteps : currentStep;
            document.getElementById('progress-bar').style.width = (display / totalSteps * 100) + '%';
            document.getElementById('progress-step').innerText = `Step ${display} / ${totalSteps}`;
        }

        updateUI();
    </script>
</body>
</html>